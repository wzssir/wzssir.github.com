<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<title>document</title>
<style>
	*{
		padding:0;
		margin:0;
	}
	body{
		background: #000;
		text-align: center;
	}
	canvas{
		background: url(img/game_bg_2_hd.jpg) no-repeat;
	}
</style>
<script src='js/source.js'></script>
<script src='js/com.js'></script>
<script src='js/fish.js'></script>
<script src='js/bottom.js'></script>
<script src='js/cannon.js'></script>
<script src='js/bullet.js'></script>
<script src='js/dieFish.js'></script>
<script>
function Coin(num){
	this.num=num;
	this.x=0;
	this.y=0;
	this.inow=0;
	this.speed=10;
	this.rotate=0;
	this.move();
}
Coin.prototype.draw=function(gd){
	var fw=FISH_SIZE[this.num].w;
	var fh=FISH_SIZE[this.num].h;
	gd.save();
	if(this.rotate>135 && this.rotate<225){
		gd.translate(this.x-fw*3/4,this.y+fh/3);
	}else{
		gd.translate(this.x,this.y);
	}
	if(this.num<3){
		gd.drawImage(json.coinAni1,0,this.inow%10*60,60,60,0,0,60,60);
	}else{
		gd.drawImage(json.coinAni2,0,this.inow%10*60,60,60,0,0,60,60);
	}

	gd.restore();
};
Coin.prototype.move=function(){
	var _this=this;
	this.rotate=
	//金币转
	setInterval(function(){
		_this.inow++;
	}, 30)
	//金币移动
	setInterval(function(){
		_this.x+=(100-_this.x)/10;
		_this.y+=(500-_this.y)/10;
	},60)
}

window.onload=function(){
	var c=document.getElementsByTagName('canvas')[0];
	var gd=c.getContext('2d');
	loadImage(aImg,function(){
		var b=new Bottom();
		var cannon=new Cannon(7);
		//存放炮弹
		var aBullet=[];
		//存放鱼
		var aFish=[];
		//存放死鱼
		var aDieFish=[];
		//存放金币
		var aCoin=[];
		setInterval(function(){
			//与出场
			if(Math.random()<0.05){
				var f=new Fish(rnd(1,6));
				if(Math.random()>0.1){
					f.x=900;
					f.rotate=rnd(135,225);
				}else{
					f.x=-100;
					f.rotate=rnd(-45,45);
				}
				f.y=rnd(100,500);

				aFish.push(f);
			}

			gd.clearRect(0,0,c.width,c.height);
			b.draw(gd);
			//画鱼
			for(var i=0; i<aFish.length; i++){
				aFish[i].draw(gd);
			}
			//画死鱼
			for(var i=0; i<aDieFish.length; i++){
				aDieFish[i].draw(gd);
			}
			//画炮弹
			for(var i=0; i<aBullet.length; i++){
				aBullet[i].draw(gd);
			}
			//画金币
			for(var i=0; i<aCoin.length; i++){
				aCoin[i].draw(gd);
			}
			cannon.draw(gd);

			//检测碰撞
			for(var i=0; i<aFish.length; i++){
				for(var j=0; j<aBullet.length; j++){
					if(aFish[i].catch(aBullet[j].x,aBullet[j].y)){
						var x=aFish[i].x;
						var y=aFish[i].y;
						var num=aFish[i].num;
						var rotate=aFish[i].rotate;
						//鱼死
						aFish.splice(i,1);
						i--;
						//生成死鱼
						var df=new Diefish(num);
						df.x=x;
						df.y=y;
						df.rotate=rotate;
						aDieFish.push(df);
						//每个500ms,删除死鱼第一个
						setTimeout(function(){
							aDieFish.shift();
						}, 500)

						//子弹消失
						aBullet.splice(j,1);
						j--;

						//生成金币
						var coin=new Coin(num);
						coin.x=x;
						coin.y=y;
						coin.rotate=rotate;
						aCoin.push(coin);
					}
				}
			}


			//优化鱼
			for(var i=0; i<aFish.length; i++){
				if(aFish[i].x<-100 || aFish[i].x>900 || aFish[i].y<-40 || aFish[i].y>c.height+40){
					aFish.splice(i,1);
					i--;
				}
			}
			//优化炮弹
			for(var i=0; i<aBullet.length; i++){
				if(aBullet[i].x<-100 || aBullet[i].x>900 || aBullet[i].y<-40 || aBullet[i].y>c.height+40){
					aBullet.splice(i,1);
					i--;
				}
			}
			//优化金币
			for(var i=0; i<aCoin.length; i++){
				if(aCoin[i].x>=80 && aCoin[i].y>=480){
					aCoin.splice(i,1);
					i--;
				}
			}
		}, 16)
		c.onclick=function(ev){
			//鼠标点击画布的坐标
			var cX=ev.clientX-c.offsetLeft;
			var cY=ev.clientY-c.offsetTop;
			//炮的中心点
			var x=424;
			var y=560;
			//炮旋转的角度
			var d=Math.atan2(y-cY,x-cX);
			cannon.rotate=a2d(d)-90;
			cannon.fire();

			var bullet=new Bullet(cannon.num);
			bullet.x=cannon.x;
			bullet.y=cannon.y;
			bullet.rotate=cannon.rotate;

			aBullet.push(bullet);
		};
	})
};	
</script>
</head>
<body>
<canvas width="800" height="600"></canvas>
</body>
</html>